<!doctype html>
<html>
  <head>
    <title>Viz Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes" />
    <meta charset="utf-8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.css" rel="stylesheet">
    <style>
      div.dc-chart {
        float: none !important;
      }
      .dc-chart g.row text {
        text-shadow: 1px 1px #000000;
      }

    </style>
  </head>
  <body>
     <nav class="navbar navbar-light bg-faded">
      <a class="navbar-brand" href="#">SparkStreaming ML</a>
      <ul class="nav navbar-nav">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home <span class="sr-only"></span></a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="/compose">Compose Viz <span class="sr-only"></span></a>
        </li>
      </ul>
      <form class="form-inline navbar-form pull-right hidden-xs">
        <input class="form-control" id="filter-all" type="text" placeholder="Filter">
        <button class="btn btn-success-outline" id="clear-filters">Clear</button>
      </form>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-xl-12 col-sm-12">
          <div class="card">
            <div class="card-header">
              Trades By Location
            </div>
            <div class="card-block">
              <div id="main-chart"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
       <div class="col-xl-4 col-sm-12">
          <div class="card">
            <div class="card-header">
              Trades By Cluster
            </div>
            <div class="card-block">
              <div id="second-chart"></div>
            </div>
          </div>
        </div>
        <div class="col-xl-4 col-md-6 col-sm-12">
          <div class="card">
            <div class="card-header">
              Trades By Category
            </div>
            <div class="card-block">
              <div id="minor-chart"></div>
            </div>
          </div>
        </div>
        <div class="col-xl-4 col-md-6 col-sm-12">
          <div class="card">
            <div class="card-header">
              Cluster Movement Over Time
            </div>
            <div class="card-block">
              <div id="second-minor-chart"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/dc/1.7.0/dc.min.js"></script>

    <script>
      var socket = io();
      var ChartViz = function() {
        this.updateDelay = 2000;
        this.charts = {};
        this.lastUpdate = new Date();
        this.data = { };
        this.colours = {
          greens: ['rgb(247,252,245)','rgb(229,245,224)','rgb(199,233,192)','rgb(161,217,155)','rgb(116,196,118)','rgb(65,171,93)','rgb(35,139,69)','rgb(0,109,44)','rgb(0,68,27)'],
          blues: ['rgb(255,247,251)','rgb(236,231,242)','rgb(208,209,230)','rgb(166,189,219)','rgb(116,169,207)','rgb(54,144,192)','rgb(5,112,176)','rgb(4,90,141)','rgb(2,56,88)'],
          redGreen: ['rgb(215,48,39)','rgb(244,109,67)','rgb(253,174,97)','rgb(254,224,139)','rgb(255,255,191)','rgb(217,239,139)','rgb(166,217,106)','rgb(102,189,99)','rgb(26,152,80)'],
          category: ['rgb(166,206,227)','rgb(31,120,180)','rgb(178,223,138)','rgb(51,160,44)','rgb(251,154,153)','rgb(227,26,28)','rgb(253,191,111)','rgb(255,127,0)','rgb(202,178,214)']
        };

        this.geoJson = {};

        this.setGeoJson = function(json) {
          this.geoJson = json;
          return this;
        };

        this.filterAll = function (text) {
          for (dataName in this.data) {
            this.data[dataName].dimensions.all.filter(function(d){return d.toLowerCase().indexOf(text.toLowerCase()) > -1;});
          }
          dc.redrawAll();
          return this;
        };

        this.clearFilters = function() {
          for (dataName in this.data) {
            for (dimensionName in this.data[dataName].dimensions) {
              this.data[dataName].dimensions[dimensionName].filterAll();
            }
          }
          dc.redrawAll();
          return this;
        }

        this.addData = function(dataName, data) {
          if (Object.prototype.toString.call( data ) != '[object Array]' ) {
              data = [data];
            }
          if (this.data[dataName] && this.data[dataName].cf) {
            this.data[dataName].cf.add(data);
          } else {
            this.data[dataName] = {};
            this.data[dataName].cf = new crossfilter(data);
            this.data[dataName].rendered = false;
            this.addDimension(dataName, 'all', function (d) {return Object.keys(d).map(function(k){ return d[k];}).join(''); });
          }

          if (this.data[dataName].cf.size() > 2) {
            if (!this.data[dataName].rendered) {
              dc.renderAll();
              this.data[dataName].rendered = true;
            } else if (new Date() - this.lastUpdate > this.updateDelay) {
              dc.redrawAll();
              this.lastUpdate = new Date();
            }
          }
          return this;
        };

        this.addDimension = function(dataName, dimensionName, dimension, grouping) {
          if (!dimension) dimension = dimensionName;
          if (typeof dimension == 'string') {
            dimension = function(d) {return d[dimension];};
          }
          this.addData(dataName,[]);
          this.data[dataName].dimensions = this.data[dataName].dimensions || {};
          this.data[dataName].groups = this.data[dataName].groups || {};
          this.data[dataName].dimensions[dimensionName] = this.data[dataName].cf.dimension(dimension);

          if (grouping) {
            if (typeof grouping == 'string') {
              this.data[dataName].groups[dimensionName] = this.data[dataName].dimensions[dimensionName].group().reduceSum(function (d) {
                  return d[grouping];
              });
            } else {
              this.data[dataName].groups[dimensionName] = this.data[dataName].dimensions[dimensionName].group().reduce(grouping.sum,grouping.sub,grouping.init);
            }
          } else {
            this.data[dataName].groups[dimensionName] = this.data[dataName].dimensions[dimensionName].group();
          }

          return this;
        };

        this.initCharts = function() {
          var self = this;
          var projection = d3.geo.mercator()
              .scale(($('#main-chart').parent().width() + 1) / 2 / Math.PI)
              .translate([$('#main-chart').parent().width() / 2, 500 / 2])
              .precision(.1);
//              .center([133,-28]) //this is aus
//              .scale(700) //fills about 500px high for aus
//              .rotate([-12,0]);

          /*Init charts */
          this.charts.country = dc.geoChoroplethChart('#main-chart')
                                  .chartGroup('trades')
                                  .height(500)
                                  .dimension(this.data.trades.dimensions.country)
                                  .group(this.data.trades.groups.country)
                                  .colors(d3.scale.category10())
                                  .colorDomain([0, 4000])
                                  .colorCalculator(function (d) {
                                      var a = self.data.trades.groups.country.top(Infinity).map(function(d){return d.value}).reverse();
                                      return d ? self.colours.redGreen[Math.round(((self.colours.redGreen.length-1)/a.length) * a.indexOf(d))] : '#ccc';
                                    })
                                  .overlayGeoJson(this.geoJson.features, "country", function (d) {
                                      return d.properties.name;
                                  })
                                  .projection(projection)
                                  .title(function (d) {
                                      return  d.key + "\nTotal Trades: " + (d.value ? d.value : 0);
                                  });
          //this.charts.cluster = dc.bubbleChart("#second-chart").chartGroup('trades_test');
          this.charts.category = dc.rowChart("#minor-chart")
                                    .chartGroup('trades')
                                    .height(500)
                                    .margins({top: 20, left: 10, right: 10, bottom: 80})
                                    .dimension(this.data.trades.dimensions.category)
                                    .group(this.data.trades.groups.category)
                                    .ordering(function(d){ return -d.value })
                                    .cap(16)
                                    // assign colors to each value in the x scale domain
                                    //.ordinalColors(d3.scale.category10())
                                    .label(function (d) {
                                        return d.key + ': ' + d.value;//key.split(".")[1];
                                    })
                                    // title sets the row text
                                    .title(function (d) {
                                        return d.key;
                                    })
          this.charts.category
                                    .elasticX(true)
                                    .xAxis().ticks(5);

          //this.charts.time = dc.barChart("#second-minor-chart").chartGroup('trades_test');

          Object.keys(this.charts).forEach(function(k){
            self.charts[k].width($(self.charts[k].anchor()).parent().width())
          });
          return this;
        };
      };

      var chartManager = new ChartViz();

      $.getJSON("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json",function(world){
        //bermuda is buggered for some reason so skip it
        world.features = world.features.filter(function(d) {return d.properties.name != 'Bermuda';})
        chartManager.setGeoJson(world)
                      .addDimension('trades','country',function(d) {return d.country;})
                      .addDimension('trades','category',function(d) {return d.category && d.category.length ? d.category : ('General: ' + d.type + ' - ' + d.unit)})
                      .initCharts();
        $("#filter-all").on('keyup', function() {
          var filterString = $(this).val();
          chartManager.filterAll(filterString);
        });
        $("#clear-filters").on('click', function() {
          var filterString = $(this).val();
          chartManager.clearFilters();
          return false;
        });
          socket.on('trades', function(msg){
              try {
                chartManager.addData('trades',JSON.parse(msg.value))
              } catch (e) {
                console.warn(e);
              }
          });
          socket.on('kmstats', function(msg){
            if (msg) {
              try {
                chartManager.addData('kmstats',JSON.parse(msg.value))
                console.log(msg);
              } catch (e) {
                console.warn(e);
              }
            }
          });
      });

     // | trade_date   | trade_time   | party   | counterparty   | ccp   | exchange   | symbol   | currency   | side   | type   | category   | price   | volume   | unit   | country   | max_bank   | max_symbol   | max_country   | max_currency   | max_exchange   | party_weight   | counterparty_weight   | exchange_weight   | country_weight   | symbol_weight   | currency_weight   |

    </script>
  </body>
</html>
